<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Crédito con Amortización</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1em;
        }
        .container {
            background-color: #fff;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 800px; /* Ancho aumentado para la tabla */
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 1.5em;
        }
        .form-group {
            margin-bottom: 1.2em;
        }
        label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #555;
        }
        input {
            width: 100%;
            padding: 0.8em;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            width: 100%;
            padding: 1em;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #results, #amortization-section {
            margin-top: 2em;
            padding-top: 1.5em;
            border-top: 2px solid #eee;
        }
        #results p {
            background-color: #ecf0f1;
            padding: 0.8em;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8em;
        }
        #results p span {
            font-weight: 600;
            color: #2980b9;
        }
        /* Estilos para la tabla de amortización */
        .table-container {
            overflow-x: auto; /* Permite scroll horizontal en móviles */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }
        th, td {
            padding: 0.75em;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: 600;
        }
        td {
            font-family: 'Courier New', Courier, monospace;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Simulador de Crédito</h1>

    <form id="credit-form">
        <div class="form-group">
            <label for="capital">Monto del Capital ($)</label>
            <input type="number" id="capital" placeholder="Ej: 2500" required>
        </div>
        <div class="form-group">
            <label for="fechaPrestamo">Fecha del Préstamo</label>
            <input type="date" id="fechaPrestamo" required>
        </div>
        <div class="form-group">
            <label for="plazo">Plazo (en meses)</label>
            <input type="number" id="plazo" placeholder="Ej: 12" required>
        </div>
        <div class="form-group">
            <label for="interes">Interés Mensual (%)</label>
            <input type="number" id="interes" placeholder="Ej: 1.5 para 1.5%" step="0.01" required>
        </div>
        <button type="button" id="calculateBtn">Calcular</button>
    </form>

    <div id="results" style="display: none;">
        <h2>Resumen del Crédito</h2>
        <p>Cuota Mensual Fija (redondeada): <span id="resultMensual"></span></p>
        <p>Monto Total a Pagar (real): <span id="resultTotalPagar"></span></p>
        <hr>
        <p>Interés Total (calculado por día): <span id="resultInteresTotal"></span></p>
        <p>Gastos Administrativos: <span id="resultGastos"></span></p>
        <hr>
        <p>Fecha Base del Cálculo: <span id="resultFechaBase"></span></p>
        <p>Fecha del Primer Pago: <span id="resultPrimerPago"></span></p>
        <p>Fecha de Fin de Crédito: <span id="resultFinCredito"></span></p>
        <p>Duración (base del interés): <span id="resultDiasPasados"></span></p>
    </div>

    <!-- SECCIÓN DE LA TABLA ACTUALIZADA -->
    <div id="amortization-section" style="display: none;">
        <h2>Tabla de Amortización Preaprobación</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Fecha Pago</th>
                        <th>Cuota Fija</th>
                        <th>Capital</th>
                        <th>Interés</th>
                        <th>Gastos Adm.</th>
                        <th>Saldo Pendiente</th>
                    </tr>
                </thead>
                <tbody id="amortization-table-body">
                    <!-- Las filas se generarán aquí con JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const calculateBtn = document.getElementById('calculateBtn');

    calculateBtn.addEventListener('click', () => {
        // --- 1. Leer los datos de entrada ---
        const capital = parseFloat(document.getElementById('capital').value);
        const fechaPrestamoStr = document.getElementById('fechaPrestamo').value;
        const plazo = parseInt(document.getElementById('plazo').value);
        const interesMensualPorcentaje = parseFloat(document.getElementById('interes').value);

        if (!capital || !fechaPrestamoStr || !plazo || isNaN(interesMensualPorcentaje)) {
            alert('Por favor, completa todos los campos correctamente.');
            return;
        }
        
        // CAMBIO: Definir las funciones de formato al principio del scope
        const formatCurrency = (value) => new Intl.NumberFormat('es-EC', { style: 'currency', currency: 'USD' }).format(value);
        const formatDate = (date) => date.toLocaleDateString('es-EC', { timeZone: 'UTC', day: '2-digit', month: 'long', year: 'numeric' });

        // --- 2. Cálculos para el RESUMEN ---
        const fechaPrestamoParts = fechaPrestamoStr.split('-').map(Number);
        const fechaPrestamo = new Date(Date.UTC(fechaPrestamoParts[0], fechaPrestamoParts[1] - 1, fechaPrestamoParts[2]));

        const fechaBase = new Date(fechaPrestamo.getTime());
        if (fechaBase.getUTCDate() <= 17) {
            fechaBase.setUTCDate(15);
        } else {
            fechaBase.setUTCMonth(fechaBase.getUTCMonth() + 1);
            fechaBase.setUTCDate(15);
        }

        const finCredito = new Date(fechaBase.getTime());
        finCredito.setUTCMonth(finCredito.getUTCMonth() + plazo);
        
        const unDiaEnMilisegundos = 1000 * 60 * 60 * 24;
        const diasPasados = Math.round((finCredito.getTime() - fechaPrestamo.getTime()) / unDiaEnMilisegundos);
        
        const fechaPrimerPago = new Date(fechaBase.getTime());
        fechaPrimerPago.setUTCMonth(fechaPrimerPago.getUTCMonth() + 1);

        let gastosAdministrativos = 0;
        if (capital < 5000) {
            gastosAdministrativos = capital * 0.038;
        } else if (capital >= 5000 && capital < 20000) {
            gastosAdministrativos = capital * 0.023;
        } else {
            gastosAdministrativos = capital * 0.018;
        }

        const interesMensualDecimal = interesMensualPorcentaje / 100;
        const tasaAnual = interesMensualDecimal * 12;
        const tasaDiaria = tasaAnual / 365;
        const totalInteres = capital * tasaDiaria * diasPasados;
        
        const totalPagarTeorico = capital + totalInteres + gastosAdministrativos;
        const pagoMensualCalculado = totalPagarTeorico / plazo;
        const pagoMensualFinal = Math.ceil(pagoMensualCalculado);
        
        // --- 3. Generar la TABLA y obtener el total real pagado ---
        const totalRealPagado = generateAmortizationTable(capital, plazo, fechaPrimerPago, pagoMensualFinal, gastosAdministrativos, totalInteres, formatCurrency, formatDate);

        // --- 4. Mostrar el RESUMEN con los valores correctos ---
        const resultsDiv = document.getElementById('results');
        
        document.getElementById('resultMensual').textContent = formatCurrency(pagoMensualFinal);
        document.getElementById('resultTotalPagar').textContent = formatCurrency(totalRealPagado);
        document.getElementById('resultInteresTotal').textContent = formatCurrency(totalInteres);
        document.getElementById('resultGastos').textContent = formatCurrency(gastosAdministrativos);
        document.getElementById('resultFechaBase').textContent = formatDate(fechaBase);
        document.getElementById('resultPrimerPago').textContent = formatDate(fechaPrimerPago);
        document.getElementById('resultFinCredito').textContent = formatDate(finCredito);
        document.getElementById('resultDiasPasados').textContent = `${diasPasados} días`;
        
        resultsDiv.style.display = 'block';
    });
    
    // CAMBIO: La función ahora recibe ambas funciones de formato como parámetros
    function generateAmortizationTable(capital, plazo, primeraFechaPago, cuotaMensual, gastosTotales, interesTotal, formatCurrency, formatDate) {
        const tableBody = document.getElementById('amortization-table-body');
        tableBody.innerHTML = '';

        let saldoPendiente = capital;
        const gastosPorCuota = gastosTotales / plazo;
        const sumOfDigits = plazo * (plazo + 1) / 2;
        let interesAcumulado = 0;
        let totalPagadoReal = 0; // Acumulador para el total real

        for (let i = 1; i <= plazo; i++) {
            let cuotaDeEsteMes = cuotaMensual;
            
            const interesDelMes = (sumOfDigits > 0) ? interesTotal * ((plazo - i + 1) / sumOfDigits) : 0;
            interesAcumulado += interesDelMes;
            
            let capitalPagado = cuotaDeEsteMes - interesDelMes - gastosPorCuota;
            
            if (i === plazo) {
                const interesRestante = interesTotal - (interesAcumulado - interesDelMes);
                capitalPagado = saldoPendiente;
                cuotaDeEsteMes = capitalPagado + interesRestante + gastosPorCuota;
            }

            saldoPendiente -= capitalPagado;
            
            if (saldoPendiente < 0.01) saldoPendiente = 0;

            totalPagadoReal += cuotaDeEsteMes; // Acumular la cuota real de este mes

            const fechaDePago = new Date(primeraFechaPago.getTime());
            fechaDePago.setUTCMonth(primeraFechaPago.getUTCMonth() + i - 1);

            const row = `
                <tr>
                    <td>${i}</td>
                    <td>${formatDate(fechaDePago)}</td>
                    <td>${formatCurrency(cuotaDeEsteMes)}</td>
                    <td>${formatCurrency(capitalPagado)}</td>
                    <td>${formatCurrency(interesDelMes)}</td>
                    <td>${formatCurrency(gastosPorCuota)}</td>
                    <td><strong>${formatCurrency(saldoPendiente)}</strong></td>
                </tr>
            `;
            tableBody.innerHTML += row;
        }

        document.getElementById('amortization-section').style.display = 'block';
        return totalPagadoReal; // Retornar el total exacto
    }
});
</script>

</body>
</html>
